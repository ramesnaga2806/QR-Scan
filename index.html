<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sticker Scanner with Excel Export</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body { font-family: Arial; }
  video { width: 100%; }
  #controls { margin-top: 15px; }
  #controls label { font-size: 16px; display:block; margin-top:10px; }
  #result {
    margin-top: 15px;
    font-size: 28px;
    font-weight: bold;
    color: green;
  }
</style>
</head>
<body>

<h2>Sticker Number Scanner</h2>

<button onclick="startCamera()">Start Camera</button>

<video id="video" autoplay playsinline></video>

<div id="controls">
  <label>Zoom:
    <input type="range" id="zoomSlider" min="1" max="10" step="0.1" value="1" oninput="applyZoom()">
  </label>

  <label>Brightness:
    <input type="range" id="brightSlider" min="0" max="300" value="100" oninput="updateFilters()">
  </label>

  <label>Contrast:
    <input type="range" id="contrastSlider" min="50" max="300" value="150" oninput="updateFilters()">
  </label>

  <label>Grayscale:
    <input type="range" id="graySlider" min="0" max="100" value="0" oninput="updateFilters()">
  </label>
</div>

<button onclick="capture()">Scan</button>
<button onclick="downloadExcel()">Download Excel</button>

<canvas id="canvas" style="display:none;"></canvas>

<div id="result"></div>

<script>
let stream;
let maxZoom = 1;
let scannedList = [];   // Store all scanned numbers

async function startCamera() {
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  const video = document.getElementById("video");
  video.srcObject = stream;

  const track = stream.getVideoTracks()[0];
  const cap = track.getCapabilities();

  if (cap.zoom) {
    maxZoom = cap.zoom.max;
    document.getElementById("zoomSlider").max = maxZoom;
  }
}

function applyZoom() {
  const zoomValue = parseFloat(document.getElementById("zoomSlider").value);
  const track = stream.getVideoTracks()[0];

  track.applyConstraints({
    advanced: [{ zoom: zoomValue }]
  });
}

function updateFilters() {
  const b = document.getElementById("brightSlider").value;
  const c = document.getElementById("contrastSlider").value;
  const g = document.getElementById("graySlider").value;

  document.getElementById("video").style.filter =
    `brightness(${b}%) contrast(${c}%) grayscale(${g}%)`;
}

async function capture() {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const result = await Tesseract.recognize(canvas, "eng");

  const match = result.data.text.match(/[0-9]{9}[A-Z]{2}/);

  if (match) {
    const code = match[0];
    document.getElementById("result").innerText = "Detected: " + code;

    // Add to list (avoid duplicates in a row)
    if (scannedList[scannedList.length - 1] !== code) {
      scannedList.push(code);
    }
  }
}

// --------------------------
// DOWNLOAD EXCEL FUNCTION
// --------------------------
function downloadExcel() {
  if (scannedList.length === 0) {
    alert("No data to download.");
    return;
  }

  const wsData = [["Sticker Number"]];

  scannedList.forEach(num => {
    wsData.push([num]);
  });

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Scans");

  XLSX.writeFile(wb, "Sticker_Scan_List.xlsx");
}
</script>

</body>
</html>
