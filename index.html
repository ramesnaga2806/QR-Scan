<!DOCTYPE html>
<html>
<head>
    <title>High Quality OCR Scanner (4K + Autofocus + Excel)</title>

    <!-- Tesseract OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <!-- Excel Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: Arial;
        }
        video {
            width: 100%;
            height: auto;
            border: 2px solid black;
            border-radius: 10px;
            object-fit: cover;
            image-rendering: high-quality;
        }
        canvas { display: none; }

        #resultBox {
            margin-top: 20px;
            font-size: 22px;
            font-weight: bold;
            padding: 10px;
            border: 2px solid green;
            border-radius: 10px;
        }

        .controls {
            margin-top: 15px;
        }

        .label {
            font-weight: bold;
        }
    </style>
</head>

<body>

<h2>Ultra HD OCR Sticker Scanner</h2>

<!-- Camera Video -->
<video id="camera" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<!-- Controls -->
<div class="controls">
    <div class="label">Zoom:</div>
    <input type="range" id="zoomSlider" min="1" max="4" step="0.1" value="1">

    <div class="label">Brightness:</div>
    <input type="range" id="brightness" min="50" max="200" value="100">

    <div class="label">Contrast:</div>
    <input type="range" id="contrast" min="50" max="200" value="100">
</div>

<br>

<button id="scanBtn">Scan Sticker</button>
<button id="downloadBtn">Download Excel</button>

<!-- Output Text -->
<div id="resultBox">Detected: (empty)</div>

<script>
    const video = document.getElementById("camera");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let capturedData = [];

    // Start 4K camera with autofocus
    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({
            video: {
                facingMode: { exact: "environment" },
                width: { ideal: 3840 },    // 4K resolution
                height: { ideal: 2160 },
                frameRate: { ideal: 60 },
                focusMode: "continuous",
                advanced: [
                    { focusMode: "continuous" },
                    { exposureMode: "continuous" },
                    { whiteBalanceMode: "continuous" }
                ]
            }
        });

        video.srcObject = stream;

        // Apply autofocus if supported
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities();

        if (caps.focusDistance) {
            track.applyConstraints({
                advanced: [{ focusDistance: caps.focusDistance.min }]
            });
        }
    }
    startCamera();

    // Brightness & Contrast Adjustments
    function applyFilters() {
        video.style.filter = `
            brightness(${document.getElementById("brightness").value}%)
            contrast(${document.getElementById("contrast").value}%)
        `;
    }
    document.getElementById("brightness").oninput = applyFilters;
    document.getElementById("contrast").oninput = applyFilters;

    // Scan Button (OCR)
    document.getElementById("scanBtn").onclick = async () => {
        let zoom = document.getElementById("zoomSlider").value;

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // Draw zoomed-in frame
        ctx.drawImage(
            video,
            canvas.width / 2 - (canvas.width / (2 * zoom)),
            canvas.height / 2 - (canvas.height / (2 * zoom)),
            canvas.width / zoom,
            canvas.height / zoom,
            0,
            0,
            canvas.width,
            canvas.height
        );

        const imageData = canvas.toDataURL("image/png");

        // OCR with whitelist
        const result = await Tesseract.recognize(imageData, "eng", {
            tessedit_char_whitelist: "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
        });

        let text = result.data.text.replace(/[^A-Z0-9]/g, "").trim();

        document.getElementById("resultBox").innerHTML = "Detected: " + text;

        if (text.length > 0) capturedData.push(text);
    };

    // Download Excel
    document.getElementById("downloadBtn").onclick = () => {
        let wb = XLSX.utils.book_new();
        let ws = XLSX.utils.aoa_to_sheet([
            ["Scanned Sticker Codes"],
            ...capturedData.map(v => [v])
        ]);
        XLSX.utils.book_append_sheet(wb, ws, "Data");
        XLSX.writeFile(wb, "StickerScan.xlsx");
    };
</script>

</body>
</html>
