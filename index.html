<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultra Sticker Number Scanner</title>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<style>
  body { font-family: Arial; }
  video { width: 100%; }
  #guide {
    position: absolute;
    top: 65%;
    left: 50%;
    width: 80%;
    height: 20%;
    transform: translateX(-50%);
    border: 3px solid red;
    border-radius: 10px;
  }
  #result {
    margin-top: 15px;
    font-size: 30px;
    font-weight: bold;
    color: green;
  }
</style>
</head>
<body>

<h3>Sticker Number Scanner</h3>
<button onclick="startCamera()">Start Camera</button>

<div style="position:relative;">
  <video id="video" autoplay playsinline></video>
  <div id="guide"></div>
</div>

<canvas id="canvas" style="display:none;"></canvas>
<div id="result"></div>

<script>
let stream;
let scanning = false;

async function startCamera() {
  stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });

  const video = document.getElementById("video");
  video.srcObject = stream;

  const track = stream.getVideoTracks()[0];
  const cap = track.getCapabilities();

  // (1) AUTO-FOCUS LOCK
  if (cap.focusMode) {
    await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
  }

  // (5) MAX ZOOM
  if (cap.zoom) {
    await track.applyConstraints({ advanced: [{ zoom: cap.zoom.max }] });
  }

  if (!scanning) {
    scanning = true;
    autoCapture();
  }
}

async function autoCapture() {
  if (!scanning) return;

  await capture();

  // (2) AUTO-CAPTURE EVERY 0.5 SEC
  setTimeout(autoCapture, 500);
}

async function capture() {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // (4) BIGGER CROP AREA (bottom 35%)
  const cropHeight = canvas.height * 0.35;
  const cropY = canvas.height - cropHeight;

  const crop = document.createElement("canvas");
  crop.width = canvas.width;
  crop.height = cropHeight;

  const cctx = crop.getContext("2d");
  cctx.drawImage(canvas, 0, cropY, canvas.width, cropHeight, 0, 0, canvas.width, cropHeight);

  // IMAGE ENHANCEMENT FOR OCR
  let img = cctx.getImageData(0, 0, crop.width, crop.height);
  let d = img.data;

  for (let i = 0; i < d.length; i += 4) {
    let avg = (d[i] + d[i+1] + d[i+2]) / 3;
    avg = avg > 140 ? 255 : 0;
    d[i] = d[i+1] = d[i+2] = avg;
  }

  cctx.putImageData(img, 0, 0);

  // OCR
  const res = await Tesseract.recognize(crop, "eng");

  // STRICT MATCH 077347722EA FORMAT
  const match = res.data.text.match(/[0-9]{9}[A-Z]{2}/);

  if (match) {
    document.getElementById("result").innerText = "Detected: " + match[0];
  }
}
</script>

</body>
</html>
