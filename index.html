<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile KKM Scanner</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

    <style>
        body { 
            margin:0; padding:0; height:100vh; background:#000; color:#fff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display:flex; flex-direction:column; overflow:hidden;
        }
        .cam-area { position:relative; flex:1; background:#000; overflow:hidden; }
        video { width:100%; height:100%; object-fit:cover; }
        .scan-box {
            position:absolute; top:50%; left:10%; right:10%; transform:translateY(-50%);
            height:56px; border:3px solid #00ff00; box-shadow:0 0 0 100vmax rgba(0,0,0,0.7);
            z-index:10;
        }
        .scan-box::after {
            content:"ALIGN CODE HERE"; position:absolute; top:-30px; left:0; width:100%;
            text-align:center; font-weight:bold; font-size:14px; color:#00ff00; text-shadow:0 0 10px #000;
        }

        .controls { 
            flex:1; background:#111; padding:20px; display:flex; flex-direction:column; gap:15px;
            border-top:2px solid #333;
        }
        #status { text-align:center; font-size:20px; font-weight:bold; color:#ffeb3b; }

        canvas { 
            border:2px solid #444; height:56px; width:280px; background:#000; 
            image-rendering: pixelated;
        }

        .slider-row label { font-size:14px; color:#aaa; }
        input[type=range] { width:100%; height:34px; }

        .btn-row { display:flex; gap:12px; margin-top:auto; }
        button {
            flex:1; padding:20px; border:none; border-radius:12px;
            font-size:18px; font-weight:bold; cursor:pointer;
        }
        .btn-scan { background:#00ff00; color:#000; }
        .btn-dl   { background:#2196F3; color:#fff; }
        button:active { transform:scale(0.97); }
    </style>
</head>
<body>

    <div class="cam-area">
        <video id="video" playsinline autoplay muted></video>
        <div class="scan-box"></div>
    </div>

    <div class="controls">
        <div style="text-align:center;font-size:12px;color:#666;">COMPUTER SEES:</div>
        <div style="display:flex;justify-content:center;">
            <canvas id="c"></canvas>
        </div>

        <div id="status">Initializing camera...</div>

        <div class="slider-row">
            <label>Threshold (adjust for glare) <span id="val">110</span></label>
            <input type="range" id="thresh" min="50" max="200" value="110">
        </div>

        <div class="btn-row">
            <button class="btn-scan" id="snapBtn">SCAN</button>
            <button class="btn-dl" onclick="downloadExcel()">EXCEL</button>
        </div>
    </div>

<script>
    const video   = document.getElementById('video');
    const canvas  = document.getElementById('c');
    const ctx     = canvas.getContext('2d');
    const status  = document.getElementById('status');
    const threshSlider = document.getElementById('thresh');
    const valSpan = document.getElementById('val');
    const snapBtn = document.getElementById('snapBtn');

    let dataList = [];
    let worker = null;

    // Update threshold value display
    threshSlider.addEventListener('input', () => {
        valSpan.textContent = threshSlider.value;
    });

    // ==================== 1. CAMERA INIT ====================
    async function initCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: { ideal: "environment" },
                    width: { ideal: 4096 },
                    height: { ideal: 2160 }
                },
                audio: false
            });
            video.srcObject = stream;
            video.play();
            status.textContent = "Camera ready – align code";
            status.style.color = "#00ff00";

            // Initialize Tesseract worker once
            worker = await Tesseract.createWorker({
                logger: m => console.log(m)
            });
            await worker.load();
            await worker.loadLanguage('eng');
            await worker.initialize('eng');
            await worker.setParameters({
                tessedit_char_whitelist: '0123456789ABCDEFGHJKLMNPQRSTUVWXYZ',
            });

            requestAnimationFrame(previewLoop);
        } catch (err) {
            status.textContent = "Camera blocked or not available";
            status.style.color = "red";
            console.error(err);
        }
    }

    // ==================== 2. PREVIEW LOOP (FIXED CROPPING) ====================
    function previewLoop() {
        if (video.readyState !== video.HAVE_ENOUGH_DATA) {
            requestAnimationFrame(previewLoop);
            return;
        }

        const TARGET_W = 280;
        const TARGET_H = 56;
        canvas.width = TARGET_W;
        canvas.height = TARGET_H;

        const vw = video.videoWidth;
        const vh = video.videoHeight;
        if (vw === 0 || vh === 0) { requestAnimationFrame(previewLoop); return; }

        const videoAspect = vw / vh;
        const displayAspect = video.clientWidth / video.clientHeight;

        let sx, sy, sw, sh;

        if (videoAspect > displayAspect) {
            // Letterboxed top/bottom → crop horizontally centered, middle 50%
            const scaledH = video.clientWidth / videoAspect;
            const cropY = (video.clientHeight - scaledH) / 2 + video.clientHeight * 0.25;
            const cropH = video.clientHeight * 0.5;

            sx = 0;
            sy = (cropY / video.clientHeight) * vh;
            sw = vw;
            sh = (cropH / video.clientHeight) * vh;
        } else {
            // Pillarboxed sides → crop vertically centered, 80% width
            const scaledW = video.clientHeight * videoAspect;
            const cropX = (video.clientWidth - scaledW) / 2 + video.clientWidth * 0.10;
            const cropW = video.clientWidth * 0.80;

            sx = (cropX / video.clientWidth) * vw;
            sy = 0;
            sw = (cropW / video.clientWidth) * vw;
            sh = vh;
        }

        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, TARGET_W, TARGET_H);

        // High-contrast threshold
        const thresh = parseInt(threshSlider.value);
        const imgData = ctx.getImageData(0, 0, TARGET_W, TARGET_H);
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            const gray = d[i] * 0.299 + d[i+1] * 0.587 + d[i+2] * 0.114;
            const val = gray > thresh ? 255 : 0;
            d[i] = d[i+1] = d[i+2] = val;
        }
        ctx.putImageData(imgData, 0, 0);

        requestAnimationFrame(previewLoop);
    }

    // ==================== 3. SCAN BUTTON ====================
    snapBtn.addEventListener('click', async () => {
        if (!worker) return;
        snapBtn.disabled = true;
        snapBtn.textContent = "Reading...";
        status.textContent = "Processing...";
        status.style.color = "#fff";

        try {
            const result = await worker.recognize(canvas);
            let text = result.data.text.toUpperCase();
            const clean = text.replace(/[^A-Z0-9]/g, '');

            if (clean.length >= 6 && /[0-9]/.test(clean)) {
                status.textContent = "FOUND: " + clean;
                status.style.color = "#00ff00";
                dataList.push({ Code: clean, Time: new Date().toLocaleString() });

                // Vibration feedback
                if ('vibrate' in navigator) navigator.vibrate(200);
            } else {
                status.textContent = "Not clear – try again";
                status.style.color = "orange";
            }
        } catch (e) {
            console.error(e);
            status.textContent = "OCR Error";
            status.style.color = "red";
        }

        setTimeout(() => {
            snapBtn.disabled = false;
            snapBtn.textContent = "SCAN";
        }, 800);
    });

    // ==================== 4. EXCEL DOWNLOAD ====================
    function downloadExcel() {
        if (dataList.length === 0) {
            alert("No scans yet!");
            return;
        }
        const ws = XLSX.utils.json_to_sheet(dataList);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "KKM_Scans");
        XLSX.writeFile(wb, `KKM_Scans_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    // Start everything
    initCamera();
</script>
</body>
</html>
